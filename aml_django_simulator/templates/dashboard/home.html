{% extends 'dashboard_base.html' %}

{% block title %}Dashboard - AML Simulator{% endblock %}

{% block dashboard_content %}
<div class="max-w-6xl mx-auto space-y-8 animate-in">
    <!-- Top Header -->
    <div class="flex justify-between items-end">
        <div>
            <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">System Overview</h1>
            <p class="text-slate-500 mt-1 font-medium">Real-time simulation metrics and alert indicators</p>
        </div>
        <button id="open-run-dialog"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-2xl font-bold transition-all shadow-lg shadow-blue-100 flex items-center group">
            <i data-lucide="play" class="mr-2 w-4 h-4 fill-white group-hover:scale-110 transition-transform"></i>
            Run New Simulation
        </button>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-4">
                <div class="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                </div>
                <div class="flex -space-x-2">
                    <div class="w-6 h-6 rounded-full border-2 border-white bg-slate-200"></div>
                    <div class="w-6 h-6 rounded-full border-2 border-white bg-slate-300"></div>
                </div>
            </div>
            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Total Alerts Detected</p>
            <h3 id="total-alerts" class="text-2xl font-black text-slate-900">0</h3>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-4">
                <div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center">
                    <i data-lucide="activity" class="w-5 h-5"></i>
                </div>
                <span class="text-xs font-bold text-emerald-600 flex items-center"><i data-lucide="trending-up"
                        class="w-3 h-3 mr-1"></i> Live</span>
            </div>
            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Transactions Scanned</p>
            <h3 id="tx-scanned" class="text-2xl font-black text-slate-900">0</h3>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-4">
                <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center">
                    <i data-lucide="users" class="w-5 h-5"></i>
                </div>
                <span class="text-[10px] font-bold text-slate-400">Total Entities</span>
            </div>
            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Customers Scanned</p>
            <h3 id="cust-scanned" class="text-2xl font-black text-slate-900">0</h3>
        </div>
    </div>

    <!-- Recent Simulations -->
    <div class="space-y-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-slate-900 flex items-center">
                <i data-lucide="history" class="mr-2 w-5 h-5 text-blue-600"></i>
                Recent Simulations
            </h2>
            <a href="/dashboard/reports/"
                class="text-sm font-bold text-blue-600 hover:text-blue-700 transition-colors">View All</a>
        </div>

        <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
            <table class="w-full text-left font-medium">
                <thead>
                    <tr
                        class="bg-slate-50/50 border-b border-slate-100 text-slate-500 text-[10px] font-extrabold uppercase tracking-widest">
                        <th class="px-6 py-4">Simulation Run</th>
                        <th class="px-6 py-4">Scenario Context</th>
                        <th class="px-6 py-4">Results</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4 text-right">Date</th>
                    </tr>
                </thead>
                <tbody id="simulations-list" class="divide-y divide-slate-50">
                    <!-- Loaded via JS -->
                </tbody>
            </table>
            <div id="sims-empty" class="hidden p-12 text-center">
                <div
                    class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300">
                    <i data-lucide="play" class="w-8 h-8"></i>
                </div>
                <p class="text-slate-500 font-bold uppercase tracking-widest text-xs">No simulations executed</p>
            </div>
        </div>
    </div>
</div>

<!-- Run Simulation Modal -->
<div id="run-modal"
    class="fixed inset-0 z-50 hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl relative overflow-hidden animate-in">
        <div class="absolute top-0 right-0 p-8">
            <button id="close-run-modal"
                class="w-10 h-10 rounded-full bg-slate-50 text-slate-400 hover:text-slate-900 hover:bg-slate-100 transition-all flex items-center justify-center">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="p-10">
            <div id="step-selector">
                <div class="flex items-center gap-3 mb-8">
                    <div
                        class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-100">
                        <i data-lucide="play" class="text-white w-5 h-5 fill-white"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-slate-900 tracking-tight">Run Simulation</h2>
                        <p class="text-slate-500 font-medium">Step 1: Select Rule Scenarios</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[40vh] overflow-y-auto p-2" id="scenarios-grid">
                    <!-- Loaded via JS -->
                </div>

                <div class="mt-8 border-t border-slate-100 pt-8 flex justify-between items-center">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest"><span
                            id="selected-count">0</span> Scenarios Selected</p>
                    <button id="next-to-dataset"
                        class="bg-slate-900 hover:bg-slate-800 text-white px-8 py-3 rounded-2xl font-bold transition-all disabled:opacity-50">Next
                        Step</button>
                </div>
            </div>

            <div id="step-dataset" class="hidden">
                <div class="flex items-center gap-3 mb-8">
                    <div
                        class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-100">
                        <i data-lucide="database" class="text-white w-5 h-5"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-slate-900 tracking-tight">Select Database</h2>
                        <p class="text-slate-500 font-medium">Step 2: Choose target dataset</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Available
                            Datasets</label>
                        <select id="dataset-select"
                            class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- Options loaded via JS -->
                        </select>
                    </div>

                    <div id="validation-spinner" class="hidden py-4 flex flex-col items-center justify-center gap-2">
                        <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-blue-600"></i>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Validating Schema...</p>
                    </div>

                    <div id="schema-mapping-ui" class="hidden space-y-4">
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-start gap-3">
                            <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600 shrink-0"></i>
                            <div>
                                <p class="text-xs font-bold text-amber-900 uppercase tracking-tight">Schema Mismatch
                                    Detected</p>
                                <p class="text-[10px] text-amber-700 font-medium">The selected dataset is missing some
                                    fields. Please map them below to proceed.</p>
                            </div>
                        </div>
                        <div id="mapping-fields" class="space-y-3 max-h-[30vh] overflow-y-auto pr-2">
                            <!-- Mapping rows injected here -->
                        </div>
                    </div>
                </div>

                <div class="mt-8 border-t border-slate-100 pt-8 flex justify-between items-center">
                    <button id="back-to-scenarios" class="text-slate-500 hover:text-slate-900 font-bold px-4">Go
                        Back</button>
                    <button id="next-to-config"
                        class="bg-slate-900 hover:bg-slate-800 text-white px-8 py-3 rounded-2xl font-bold transition-all">Continue</button>
                </div>
            </div>

            <div id="step-config" class="hidden">
                <div class="flex items-center gap-3 mb-8">
                    <div
                        class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-100">
                        <i data-lucide="settings-2" class="text-white w-5 h-5"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-slate-900 tracking-tight">Configuration</h2>
                        <p class="text-slate-500 font-medium">Step 3: Define Parameters</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-xs font-black text-slate-500 uppercase tracking-widest ml-1">Analysis Period
                            Start</label>
                        <input type="date" id="date-start" value="2024-01-01"
                            class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-black text-slate-500 uppercase tracking-widest ml-1">Analysis Period
                            End</label>
                        <input type="date" id="date-end" value="2024-12-31"
                            class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <div id="schema-status"
                    class="mt-8 p-6 bg-slate-50 rounded-3xl border border-slate-100 flex items-center gap-4">
                    <div
                        class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center animate-pulse">
                        <i data-lucide="check" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-slate-900">Schema Validated</p>
                        <p class="text-xs text-slate-500">Your dataset contains all required fields for selected rules.
                        </p>
                    </div>
                </div>

                <div class="mt-8 border-t border-slate-100 pt-8 flex justify-between items-center">
                    <button id="back-to-dataset" class="text-slate-500 hover:text-slate-900 font-bold px-4">Go
                        Back</button>
                    <button id="execute-run"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-3.5 rounded-2xl font-bold transition-all shadow-lg shadow-blue-200 flex items-center group">
                        Launch Engine
                        <i data-lucide="box" class="ml-2 w-4 h-4 group-hover:rotate-12 transition-transform"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let scenarios = [];
    let datasets = [];
    let selectedScenarios = [];

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Fetch Stats & Scenarios
    async function initDashboard() {
        try {
            const [statsRes, rulesRes, datasetsRes] = await Promise.all([
                fetch('/api/dashboard/stats/').then(r => r.json()),
                fetch('/api/rules/scenarios/').then(r => r.json()),
                fetch('/api/simulation/datasets/').then(r => r.json())
            ]);

            datasets = datasetsRes;
            populateDatasetSelect();

            // Update Stats
            document.getElementById('total-alerts').textContent = statsRes.total_alerts.toLocaleString();
            document.getElementById('tx-scanned').textContent = statsRes.transactions_scanned.toLocaleString();
            document.getElementById('cust-scanned').textContent = statsRes.customers_scanned.toLocaleString();

            // Update Simulations Table
            const simsTable = document.getElementById('simulations-list');
            const simsEmpty = document.getElementById('sims-empty');

            if (statsRes.recent_simulations && statsRes.recent_simulations.length > 0) {
                simsTable.innerHTML = statsRes.recent_simulations.map(s => `
                    <tr class="hover:bg-slate-50/50 transition-colors group cursor-pointer" onclick="window.location.href='/dashboard/reports/'">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-400 group-hover:text-blue-600 transition-colors">
                                    <i data-lucide="play" class="w-3 h-3 fill-current"></i>
                                </div>
                                <div>
                                    <span class="font-bold text-slate-800 text-sm">Run #${s.run_number}</span>
                                    <p class="text-[10px] text-slate-400 font-mono">ID: ${s.run_id.slice(-4)}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-[10px] font-bold text-slate-500">
                            <div class="flex flex-wrap gap-1">
                                ${(s.scenario_names || []).map(name => `<span class="px-1.5 py-0.5 bg-slate-50 border border-slate-100 rounded text-[8px] text-slate-400 uppercase">${name}</span>`).join('')}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                             <span class="inline-flex px-2 py-0.5 rounded-lg bg-blue-50 text-blue-600 text-[10px] font-black">${s.total_alerts} ALERTS</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-tighter ${s.status === 'completed' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'}">${s.status}</span>
                        </td>
                        <td class="px-6 py-4 text-right text-xs font-bold text-slate-400">${new Date(s.created_at).toLocaleDateString()}</td>
                    </tr>
                `).join('');
                simsEmpty.classList.add('hidden');
                lucide.createIcons();
            } else {
                simsEmpty.classList.remove('hidden');
            }

            scenarios = rulesRes;
            renderScenarios();

        } catch (e) {
            console.error("Dashboard init failed", e);
        }
    }

    function renderScenarios() {
        const grid = document.getElementById('scenarios-grid');
        grid.innerHTML = scenarios.map(s => `
            <div class="scenario-card p-4 rounded-3xl border-2 transition-all cursor-pointer ${selectedScenarios.includes(s.scenario_id) ? 'border-blue-600 bg-blue-50/50' : 'border-slate-100 bg-slate-50/50 hover:border-slate-200'}" 
                 onclick="toggleScenario('${s.scenario_id}')">
                <div class="flex items-start justify-between mb-2">
                    <span class="px-2 py-1 bg-white rounded-lg text-[8px] font-black text-slate-400 border border-slate-100 uppercase tracking-widest">PRO</span>
                    <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center ${selectedScenarios.includes(s.scenario_id) ? 'bg-blue-600 border-blue-600 text-white' : 'border-slate-200'}">
                        ${selectedScenarios.includes(s.scenario_id) ? '<i data-lucide="check" class="w-3 h-3"></i>' : ''}
                    </div>
                </div>
                <h4 class="font-black text-slate-900 text-sm mb-1">${s.scenario_name}</h4>
                <p class="text-[10px] text-slate-500 font-medium leading-tight">${s.description || 'Behavioral pattern analysis'}</p>
            </div>
        `).join('');
        document.getElementById('selected-count').textContent = selectedScenarios.length;
        document.getElementById('next-to-config').disabled = selectedScenarios.length === 0;
        lucide.createIcons();
    }

    window.toggleScenario = (id) => {
        if (selectedScenarios.includes(id)) {
            selectedScenarios = selectedScenarios.filter(x => x !== id);
        } else {
            selectedScenarios.push(id);
        }
        renderScenarios();
    };

    function populateDatasetSelect() {
        const select = document.getElementById('dataset-select');
        select.innerHTML = datasets.map(d => `
            <option value="${d.upload_id}">${d.dataset_name} (${d.record_count_transactions.toLocaleString()} txns)</option>
        `).join('');
    }

    let fieldMappings = {};
    let schemaValidation = null;

    async function validateSelectedSchema() {
        const uploadId = document.getElementById('dataset-select').value;
        const spinner = document.getElementById('validation-spinner');
        const mappingUI = document.getElementById('schema-mapping-ui');
        const mappingFields = document.getElementById('mapping-fields');
        const nextBtn = document.getElementById('next-to-config');

        spinner.classList.remove('hidden');
        mappingUI.classList.add('hidden');
        nextBtn.disabled = true;

        try {
            const res = await fetch('/api/simulation/validate-schema/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    upload_id: uploadId,
                    scenario_ids: selectedScenarios
                })
            });

            schemaValidation = await res.json();

            if (schemaValidation.is_valid) {
                nextBtn.disabled = false;
                fieldMappings = {};
            } else {
                nextBtn.disabled = false; // Allow proceeding even with mapping needed, we'll validate mapping before next
                mappingUI.classList.remove('hidden');

                mappingFields.innerHTML = schemaValidation.missing_fields.map(f => `
                    <div class="flex items-center gap-4 bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                        <div class="flex-1">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${f.source_table} Field</p>
                            <p class="font-bold text-slate-900 text-xs">${f.rule_field}</p>
                        </div>
                        <i data-lucide="arrow-right" class="w-4 h-4 text-slate-300"></i>
                        <div class="flex-1">
                            <select onchange="updateMapping('${f.rule_field}', this.value)" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-2 py-1 text-xs font-bold text-slate-700 outline-none">
                                <option value="">Select Column...</option>
                                ${(f.source_table === 'transaction' ? schemaValidation.available_columns.transactions : schemaValidation.available_columns.customers).map(col => `
                                    <option value="${col}">${col}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            }
        } catch (e) {
            console.error("Schema validation failed", e);
        } finally {
            spinner.classList.add('hidden');
        }
    }

    window.updateMapping = (ruleField, colName) => {
        if (colName) {
            fieldMappings[ruleField] = colName;
        } else {
            delete fieldMappings[ruleField];
        }
    };

    // Modal Controls
    const runModal = document.getElementById('run-modal');
    document.getElementById('open-run-dialog').addEventListener('click', () => {
        runModal.classList.remove('hidden');
        selectedScenarios = scenarios.filter(s => s.is_active).map(s => s.scenario_id);
        renderScenarios();
    });

    document.getElementById('close-run-modal').addEventListener('click', () => {
        runModal.classList.add('hidden');
        // Reset steps
        document.getElementById('step-selector').classList.remove('hidden');
        document.getElementById('step-dataset').classList.add('hidden');
        document.getElementById('step-config').classList.add('hidden');
    });

    document.getElementById('next-to-dataset').addEventListener('click', async () => {
        document.getElementById('step-selector').classList.add('hidden');
        document.getElementById('step-dataset').classList.remove('hidden');
        await validateSelectedSchema();
        lucide.createIcons();
    });

    document.getElementById('dataset-select').addEventListener('change', validateSelectedSchema);

    document.getElementById('back-to-scenarios').addEventListener('click', () => {
        document.getElementById('step-dataset').classList.add('hidden');
        document.getElementById('step-selector').classList.remove('hidden');
    });

    document.getElementById('next-to-config').addEventListener('click', () => {
        // Validate all missing fields are mapped
        if (!schemaValidation.is_valid) {
            const mappedCount = Object.keys(fieldMappings).length;
            if (mappedCount < schemaValidation.missing_fields.length) {
                alert('Please map all missing fields before proceeding.');
                return;
            }
        }

        document.getElementById('step-dataset').classList.add('hidden');
        document.getElementById('step-config').classList.remove('hidden');
        lucide.createIcons();
    });

    document.getElementById('back-to-dataset').addEventListener('click', () => {
        document.getElementById('step-config').classList.add('hidden');
        document.getElementById('step-dataset').classList.remove('hidden');
    });

    document.getElementById('execute-run').addEventListener('click', async () => {
        const btn = document.getElementById('execute-run');
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader" class="animate-spin w-4 h-4"></i>';
        lucide.createIcons();

        try {
            const res = await fetch('/api/simulation/run/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    scenarios: selectedScenarios,
                    run_type: 'ad_hoc',
                    upload_id: document.getElementById('dataset-select').value,
                    field_mappings: fieldMappings,
                    date_range_start: document.getElementById('date-start').value,
                    date_range_end: document.getElementById('date-end').value
                })
            });

            if (res.ok) {
                window.location.href = '/dashboard/reports/';
            } else {
                throw new Error('Simulation failed');
            }
        } catch (e) {
            alert(e.message);
            btn.disabled = false;
            btn.textContent = 'Launch Engine';
            lucide.createIcons();
        }
    });

    initDashboard();
</script>
{% endblock %}