{% extends 'dashboard_base.html' %}

{% block title %}Comparison - AML Simulator{% endblock %}

{% block dashboard_content %}
<div class="max-w-7xl mx-auto space-y-8 animate-in">
    <!-- Header -->
    <div class="flex justify-between items-end">
        <div>
            <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Strategy Comparison</h1>
            <p class="text-slate-500 mt-1 font-medium">A/B testing for rule calibration and efficiency benchmarking</p>
        </div>
        <div class="flex gap-3">
            <button id="export-compare-btn"
                class="hidden bg-white border border-slate-200 text-slate-600 px-5 py-2.5 rounded-xl font-bold transition-all flex items-center gap-2">
                <i data-lucide="download" class="w-4 h-4"></i>
                Export Comparison
            </button>
        </div>
    </div>

    <!-- Selection Panel -->
    <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-slate-100">
        <div class="grid md:grid-cols-7 gap-6 items-center">
            <div class="md:col-span-3 space-y-2">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Baseline Strategy
                    (Control)</label>
                <select id="baseline-select"
                    class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Baseline Rule...</option>
                </select>
                <div id="baseline-run-info" class="text-[10px] font-bold text-slate-400 ml-1 mt-1"></div>
            </div>

            <div class="md:col-span-1 flex justify-center">
                <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-400 flex items-center justify-center">
                    <i data-lucide="arrow-right-left" class="w-5 h-5"></i>
                </div>
            </div>

            <div class="md:col-span-3 space-y-2">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Refined Strategy
                    (Target)</label>
                <select id="refined-select"
                    class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Refined Rule...</option>
                </select>
                <div id="refined-run-info" class="text-[10px] font-bold text-slate-400 ml-1 mt-1"></div>
            </div>
        </div>

        <div class="mt-8 flex justify-center">
            <button id="compare-btn"
                class="bg-slate-900 hover:bg-slate-800 text-white px-12 py-4 rounded-2xl font-black transition-all shadow-xl shadow-slate-200 flex items-center gap-3 group">
                Generate Differential Analysis
                <i data-lucide="zap" class="w-5 h-5 text-blue-400 group-hover:scale-125 transition-transform"></i>
            </button>
        </div>
    </div>

    <!-- Comparison Results (Hidden initially) -->
    <div id="compare-results" class="hidden space-y-8 animate-in">
        <!-- Summary Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i data-lucide="target" class="w-16 h-16 text-slate-900"></i>
                </div>
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Efficiency Delta</p>
                <h3 id="res-reduction" class="text-4xl font-black text-emerald-600">0%</h3>
                <p class="text-xs font-bold text-slate-500 mt-2">Reduction in alert volume</p>
            </div>

            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
                <div class="flex items-center gap-4 mb-4">
                    <div class="flex-1">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Baseline</p>
                        <p id="res-baseline-count" class="text-2xl font-black text-slate-900">0</p>
                        <p id="res-baseline-date" class="text-[8px] font-bold text-slate-400"></p>
                    </div>
                    <div class="h-8 w-px bg-slate-100"></div>
                    <div class="flex-1">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Refined</p>
                        <p id="res-refined-count" class="text-2xl font-black text-blue-600">0</p>
                        <p id="res-refined-date" class="text-[8px] font-bold text-slate-400"></p>
                    </div>
                </div>
                <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden flex">
                    <div id="bar-refined" class="h-full bg-blue-600" style="width: 70%"></div>
                    <div id="bar-diff" class="h-full bg-emerald-400/30" style="width: 30%"></div>
                </div>
            </div>

            <div class="bg-slate-900 p-8 rounded-[2.5rem] text-white shadow-2xl shadow-blue-900/10">
                <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1">Risk Preservation</p>
                <h3 id="res-risk" class="text-3xl font-black">High (98%)</h3>
                <p id="res-risk-sub" class="text-[10px] text-slate-400 mt-2">Coverage maintained for critical segments
                </p>
            </div>
        </div>

        <!-- Granular Diff Table -->
        <div class="bg-white rounded-[3rem] border border-slate-100 shadow-sm overflow-hidden">
            <table class="w-full text-left">
                <thead>
                    <tr
                        class="bg-slate-50/50 border-b border-slate-100 text-slate-500 text-[10px] font-black uppercase tracking-widest">
                        <th class="px-8 py-6">Customer Entity</th>
                        <th class="px-8 py-6">Status Delta</th>
                        <th class="px-8 py-6">Exposure Score</th>
                        <th class="px-8 py-6">Comparison Context</th>
                        <th class="px-8 py-6 text-right">Impact</th>
                    </tr>
                </thead>
                <tbody id="diff-body" class="divide-y divide-slate-50">
                    <!-- Loaded via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- No Run Data Modal -->
<div id="no-run-modal"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-6">
    <div
        class="bg-white w-full max-w-lg rounded-[3.5rem] shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
        <div class="p-12 text-center space-y-6">
            <div class="w-20 h-20 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-circle" class="w-10 h-10 text-amber-500"></i>
            </div>
            <div>
                <h3 class="text-2xl font-black text-slate-900">Missing Simulation Data</h3>
                <p class="text-slate-500 font-medium mt-2">A simulation must be run for this rule before it can be
                    compared. Would you like to launch one now?</p>
            </div>
            <div id="missing-scenario-name"
                class="px-6 py-3 bg-slate-50 rounded-2xl text-sm font-bold text-slate-600 inline-block">
                Scenario: Unknown
            </div>
            <div class="flex gap-4 pt-4">
                <button onclick="closeNoRunModal()"
                    class="flex-1 px-8 py-4 rounded-2xl font-black text-slate-500 hover:bg-slate-50 transition-all">
                    Cancel
                </button>
                <a href="/dashboard/"
                    class="flex-1 bg-slate-900 text-white px-8 py-4 rounded-2xl font-black text-center shadow-lg shadow-slate-200 hover:shadow-xl transition-all">
                    Run Simulation
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let scenarios = [];
    let currentBaselineRun = null;
    let currentRefinedRun = null;

    async function init() {
        try {
            const res = await fetch('/api/rules/scenarios/');
            scenarios = await res.json();

            const bSelect = document.getElementById('baseline-select');
            const rSelect = document.getElementById('refined-select');

            const options = scenarios.map(s => `
                <option value="${s.scenario_id}">${s.scenario_name}</option>
            `).join('');

            bSelect.innerHTML += options;
            rSelect.innerHTML += options;

            // Listen for changes to fetch latest runs
            bSelect.addEventListener('change', (e) => handleScenarioSelect(e.target.value, 'baseline'));
            rSelect.addEventListener('change', (e) => handleScenarioSelect(e.target.value, 'refined'));

        } catch (e) {
            console.error("Failed to load scenarios", e);
        }
    }

    async function handleScenarioSelect(scenarioId, type) {
        const infoDiv = document.getElementById(`${type}-run-info`);
        if (!scenarioId) {
            infoDiv.textContent = "";
            if (type === 'baseline') currentBaselineRun = null;
            else currentRefinedRun = null;
            return;
        }

        try {
            const res = await fetch(`/api/rules/latest-run/${scenarioId}`);
            if (res.status === 404) {
                const scenario = scenarios.find(s => s.scenario_id === scenarioId);
                showNoRunModal(scenario?.scenario_name || "Unknown");
                infoDiv.textContent = "No simulation data available.";
                infoDiv.className = "text-[10px] font-bold text-red-400 ml-1 mt-1";
                if (type === 'baseline') currentBaselineRun = null;
                else currentRefinedRun = null;
                return;
            }

            const run = await res.json();
            const date = new Date(run.created_at).toLocaleString();
            infoDiv.textContent = `Latest Execution: ${date} (${run.total_alerts} alerts)`;
            infoDiv.className = "text-[10px] font-bold text-blue-500 ml-1 mt-1";

            if (type === 'baseline') currentBaselineRun = run.run_id;
            else currentRefinedRun = run.run_id;

        } catch (e) {
            console.error(e);
        }
    }

    function showNoRunModal(name) {
        document.getElementById('missing-scenario-name').textContent = `Scenario: ${name}`;
        document.getElementById('no-run-modal').classList.remove('hidden');
        document.getElementById('no-run-modal').classList.add('flex');
        lucide.createIcons();
    }

    function closeNoRunModal() {
        document.getElementById('no-run-modal').classList.add('hidden');
        document.getElementById('no-run-modal').classList.remove('flex');
    }

    document.getElementById('compare-btn').addEventListener('click', async () => {
        const bSid = document.getElementById('baseline-select').value;
        const rSid = document.getElementById('refined-select').value;

        if (!bSid || !rSid) {
            alert("Please select both baseline and refined strategies.");
            return;
        }

        if (!currentBaselineRun || !currentRefinedRun) {
            alert("One or more selected strategies do not have recent simulation data.");
            return;
        }

        const btn = document.getElementById('compare-btn');
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader" class="animate-spin w-5 h-5"></i> Analyzing...';
        lucide.createIcons();

        try {
            const res = await fetch('/api/comparison/compare/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    baseline_scenario_id: bSid,
                    refined_scenario_id: rSid
                })
            });
            const data = await res.json();

            renderResults(data);
            document.getElementById('compare-results').classList.remove('hidden');
            document.getElementById('export-compare-btn').classList.remove('hidden');
        } catch (e) {
            alert("Comparison failed");
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Generate Differential Analysis <i data-lucide="zap" class="w-5 h-5 text-blue-400"></i>';
            lucide.createIcons();
        }
    });

    function renderResults(data) {
        document.getElementById('res-reduction').textContent = `${data.summary.reduction_rate}%`;
        document.getElementById('res-baseline-count').textContent = data.summary.baseline_alerts;
        document.getElementById('res-refined-count').textContent = data.summary.refined_alerts;

        document.getElementById('res-baseline-date').textContent = new Date(data.summary.baseline_date).toLocaleDateString();
        document.getElementById('res-refined-date').textContent = new Date(data.summary.refined_date).toLocaleDateString();

        const total = data.summary.baseline_alerts || 1;
        const refinedPct = (data.summary.refined_alerts / total) * 100;
        document.getElementById('bar-refined').style.width = `${refinedPct}%`;
        document.getElementById('bar-diff').style.width = `${Math.max(0, 100 - refinedPct)}%`;

        document.getElementById('res-risk').textContent = data.risk_analysis.risk_level;
        document.getElementById('res-risk-sub').textContent = `Exposure Score: ${data.risk_analysis.risk_score}%`;

        const body = document.getElementById('diff-body');
        body.innerHTML = data.granular_diff.map(item => `
            <tr class="hover:bg-slate-50/50 transition-colors">
                <td class="px-8 py-6">
                    <p class="font-bold text-slate-900 text-sm">Entity #${item.customer_id.slice(-6)}</p>
                    <p class="text-[10px] text-slate-400 font-mono">${item.customer_id}</p>
                </td>
                <td class="px-8 py-6">
                    <span class="px-3 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest ${item.status === 'removed' ? 'bg-emerald-50 text-emerald-600' :
                item.status === 'added' ? 'bg-amber-50 text-amber-600' : 'bg-blue-50 text-blue-600'
            }">
                        ${item.status}
                    </span>
                </td>
                <td class="px-8 py-6">
                    <div class="flex items-center gap-2">
                        <div class="flex-grow h-1.5 bg-slate-100 rounded-full w-16">
                            <div class="h-full bg-slate-400 rounded-full" style="width: ${item.risk_score}%"></div>
                        </div>
                        <span class="text-[10px] font-bold text-slate-400">${item.risk_score}</span>
                    </div>
                </td>
                <td class="px-8 py-6">
                    <div class="flex flex-col">
                        <span class="text-[10px] font-black uppercase text-slate-500">${item.scenario}</span>
                        <span class="text-[8px] text-slate-400 mt-1 italic">${item.reason || ''}</span>
                    </div>
                </td>
                <td class="px-8 py-6 text-right">
                    <span class="text-xs font-black ${item.status === 'removed' ? 'text-emerald-500' : (item.risk_change > 0 ? 'text-red-500' : 'text-slate-900')}">
                        ${item.status === 'removed' ? '-100%' : (item.risk_change > 0 ? '+' : '') + item.risk_change + '%'}
                    </span>
                </td>
            </tr>
        `).join('');
        lucide.createIcons();
    }

    document.getElementById('export-compare-btn').addEventListener('click', () => {
        if (currentBaselineRun && currentRefinedRun) {
            window.location.href = `/api/comparison/compare/${currentBaselineRun}/${currentRefinedRun}/export/`;
        }
    });

    init();
</script>
{% endblock %}